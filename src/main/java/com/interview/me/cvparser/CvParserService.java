package com.interview.me.cvparser;


import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.interview.me.domain.EducationEntry;
import com.interview.me.domain.PersonalDetail;
import com.interview.me.domain.WorkExperienceEntry;
import com.mashape.unirest.http.HttpResponse;
import com.mashape.unirest.http.Unirest;
import com.mashape.unirest.http.exceptions.UnirestException;
import org.apache.commons.io.FileUtils;
import org.json.JSONArray;
import org.json.JSONObject;
import org.springframework.stereotype.Service;

import java.io.File;
import java.io.IOException;
import java.time.Instant;
import java.time.LocalDate;
import java.time.ZoneOffset;
import java.util.Arrays;
import java.util.Set;
import java.util.stream.Collectors;

@Service
public class CvParserService {

    private static final String PERSONAL_INFOS = "personal_infos";
    private static final String EDUCATION = "education";
    private static final String WORK_EXPERIENCE = "work_experience";
    private static final String LANGUAGES = "languages";
    private static final String SKILLS = "skills";
    private static final String CERTIFICATIONS = "certifications";
    private static final String COURSES = "courses";
    private static final String PUBLICATIONS = "publications";
    private static final String INTERESTS = "interests";

    public PersonalDetail parse(byte[] cv , String cvContentType) throws UnirestException, IOException {

        Unirest.setTimeouts(0, 0);
        HttpResponse<String> response = Unirest.post("https://api.edenai.run/v2/ocr/resume_parser")
            .header("authorization", "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNDc2OWNhMzUtNjE2Mi00NzdkLTgzNWItNDJlZjEyZDljNzE3IiwidHlwZSI6ImFwaV90b2tlbiJ9.FFMJ-KOT-KwcltCDftWyOuL_ekzyG4u094surYoJCq0")
            .field("providers", "affinda")
            .field("file",byteToFile(cv))
            .field("language", "en")
            .field("fallback_providers", "")
            .asString();

        ObjectMapper mapper = new ObjectMapper();

      //  String json = "{    \"affinda\": {        \"status\": \"success\",        \"extracted_data\": {            \"personal_infos\": {                \"name\": {                    \"first_name\": \"Ahmet\",                    \"last_name\": \"Uygun\",                    \"raw_name\": \"AHMET UYGUN\",                    \"middle\": \"\",                    \"title\": \"\",                    \"prefix\": null,                    \"sufix\": null                },                \"address\": {                    \"formatted_location\": \"Marino Park Avenue, Dublin, Ireland\",                    \"postal_code\": null,                    \"region\": \"Dublin\",                    \"country\": \"Ireland\",                    \"country_code\": \"IE\",                    \"raw_input_location\": \"Marino Park Ave. Dublin Ireland\",                    \"street\": \"Marino Park Avenue\",                    \"street_number\": null,                    \"appartment_number\": null,                    \"city\": \"Dublin\"                },                \"self_summary\": \"Experienced Sr Java Software Engineer with 9+ years of expertise in full project lifecycle development using Java technologies. Proficient in Java backend development and skilled in JavaScript-based frameworks including React, Angular, and React Native. Demonstrated expertise in Microservices, Domain Driven Desing, Event Driven Programming, and Reactive Programming, as well as other programming paradigms for handling high volume transactions. Proficient in Java, Spring Framework (Boot, Security, Data, Rest, etc.), Microservice instruments (Eureka, Hystrix, Zool), JMS, Kafka, Debezium, OpenShift AMQ Broker, Docker, AWS, Junit, Mockito, and RDMS (MySQL, PostgreSQL, Oracle), with additional skills in Angular, React, React Native, and Jhipster.\",                \"objective\": \"\",                \"date_of_birth\": null,                \"place_of_birth\": null,                \"phones\": [                    \"+353851066672\"                ],                \"mails\": [                    \"ygnhmt@gmail.com\"                ],                \"urls\": [                    \"https://github.com/ahmetuygun\",                    \"https://medium.com/@ygnhmt\",                    \"www.linkedin.com/ahmetuygun\",                    \"http://www.linkedin.com/ahmetuygun\"                ],                \"fax\": [],                \"current_profession\": \"Software Engineer Java\",                \"gender\": null,                \"nationality\": null,                \"martial_status\": null,                \"current_salary\": null            },            \"education\": {                \"total_years_education\": null,                \"entries\": [                    {                        \"title\": null,                        \"start_date\": \"2009-01-01\",                        \"end_date\": \"2014-01-01\",                        \"location\": {                            \"formatted_location\": \"İstanbul, Turkey\",                            \"postal_code\": null,                            \"region\": \"İstanbul\",                            \"country\": \"Turkey\",                            \"country_code\": \"TR\",                            \"raw_input_location\": \"ISTANBUL\",                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": \"İstanbul\"                        },                        \"establishment\": \"Kadir Has University\",                        \"description\": null,                        \"gpa\": null,                        \"accreditation\": \"B.SC, INFORMATION TECHNOLOGIES,\"                    },                    {                        \"title\": null,                        \"start_date\": \"2013-01-01\",                        \"end_date\": \"2013-01-01\",                        \"location\": {                            \"formatted_location\": \"Leicester, UK\",                            \"postal_code\": null,                            \"region\": \"England\",                            \"country\": \"United Kingdom\",                            \"country_code\": \"GB\",                            \"raw_input_location\": \"LEICESTER UK\",                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": \"Leicester\"                        },                        \"establishment\": null,                        \"description\": null,                        \"gpa\": null,                        \"accreditation\": \"ERASMUS EXCHANGE PROGRAME,\"                    }                ]            },            \"work_experience\": {                \"total_years_experience\": null,                \"entries\": [                    {                        \"title\": \"SR JAVA SOFTWARE ENGINEER\",                        \"start_date\": \"2022-12-01\",                        \"end_date\": \"2024-01-28\",                        \"company\": \"VERSION 1, DUBLIN, IRELAND (ON SIDE)\",                        \"location\": {                            \"formatted_location\": null,                            \"postal_code\": null,                            \"region\": null,                            \"country\": null,                            \"country_code\": null,                            \"raw_input_location\": null,                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": null                        },                        \"description\": null,                        \"industry\": null                    },                    {                        \"title\": \"SR JAVA SOFTWARE ENGINEER\",                        \"start_date\": \"2021-10-01\",                        \"end_date\": \"2022-12-01\",                        \"company\": \"DERAYAH FINANCIAL (D360 DIGITAL BANK), RIYADH DE\",                        \"location\": {                            \"formatted_location\": null,                            \"postal_code\": null,                            \"region\": null,                            \"country\": null,                            \"country_code\": null,                            \"raw_input_location\": null,                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": null                        },                        \"description\": null,                        \"industry\": null                    },                    {                        \"title\": \"SR JAVA SOFTWARE ENGINEER\",                        \"start_date\": \"2020-10-01\",                        \"end_date\": \"2021-10-01\",                        \"company\": \"DAIMLER MOBILITY AG, STUTTGART DE\",                        \"location\": {                            \"formatted_location\": null,                            \"postal_code\": null,                            \"region\": null,                            \"country\": null,                            \"country_code\": null,                            \"raw_input_location\": null,                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": null                        },                        \"description\": null,                        \"industry\": null                    },                    {                        \"title\": \"SR JAVA SOFTWARE ENGINEER\",                        \"start_date\": \"2019-05-01\",                        \"end_date\": \"2021-10-01\",                        \"company\": \"VODAFONE, ISTANBUL (ON SIDE)\",                        \"location\": {                            \"formatted_location\": null,                            \"postal_code\": null,                            \"region\": null,                            \"country\": null,                            \"country_code\": null,                            \"raw_input_location\": null,                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": null                        },                        \"description\": null,                        \"industry\": null                    },                    {                        \"title\": \"JAVA SOFTWARE ENGINEER\",                        \"start_date\": \"2017-04-01\",                        \"end_date\": \"2019-05-01\",                        \"company\": \"Ergo Insurance\",                        \"location\": {                            \"formatted_location\": \"İstanbul, Turkey\",                            \"postal_code\": null,                            \"region\": \"İstanbul\",                            \"country\": \"Turkey\",                            \"country_code\": \"TR\",                            \"raw_input_location\": \"ISTANBUL\",                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": \"İstanbul\"                        },                        \"description\": null,                        \"industry\": null                    },                    {                        \"title\": \"JAVA SOFTWARE ENGINEER\",                        \"start_date\": \"2014-02-01\",                        \"end_date\": \"2017-04-01\",                        \"company\": \"Netas Telecom\",                        \"location\": {                            \"formatted_location\": \"İstanbul, Turkey\",                            \"postal_code\": null,                            \"region\": \"İstanbul\",                            \"country\": \"Turkey\",                            \"country_code\": \"TR\",                            \"raw_input_location\": \"ISTANBUL\",                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": \"İstanbul\"                        },                        \"description\": null,                        \"industry\": null                    }                ]            },            \"languages\": [                {                    \"name\": \"Portuguese\",                    \"code\": null                },                {                    \"name\": \"English\",                    \"code\": null                }            ],            \"skills\": [                {                    \"name\": \"Hibernate (Java)\",                    \"type\": \"hard\"                },                {                    \"name\": \"Microservices\",                    \"type\": \"hard\"                },                {                    \"name\": \"Java (Programming Language)\",                    \"type\": \"hard\"                },                {                    \"name\": \"SMS\",                    \"type\": \"hard\"                },                {                    \"name\": \"Monoliths\",                    \"type\": \"hard\"                },                {                    \"name\": \"Amazon S3\",                    \"type\": \"hard\"                },                {                    \"name\": \"Application Programming Interface (API)\",                    \"type\": \"hard\"                },                {                    \"name\": \"User Experience Design (UX)\",                    \"type\": \"hard\"                },                {                    \"name\": \"Zope (CMS)\",                    \"type\": \"hard\"                },                {                    \"name\": \"SQL (Programming Language)\",                    \"type\": \"hard\"                },                {                    \"name\": \"Apache Kafka\",                    \"type\": \"hard\"                },                {                    \"name\": \"Amazon Web Services\",                    \"type\": \"hard\"                },                {                    \"name\": \"Jhipster\",                    \"type\": \"hard\"                },                {                    \"name\": \"MySQL\",                    \"type\": \"hard\"                },                {                    \"name\": \"Management\",                    \"type\": \"soft\"                },                {                    \"name\": \"Docker (Software)\",                    \"type\": \"hard\"                },                {                    \"name\": \"Mobile App\",                    \"type\": \"hard\"                },                {                    \"name\": \"Communications\",                    \"type\": \"soft\"                },                {                    \"name\": \"Spring Framework\",                    \"type\": \"hard\"                },                {                    \"name\": \"React Native\",                    \"type\": \"hard\"                },                {                    \"name\": \"OpenShift\",                    \"type\": \"hard\"                },                {                    \"name\": \"Staging\",                    \"type\": \"hard\"                },                {                    \"name\": \"Spring Security\",                    \"type\": \"hard\"                },                {                    \"name\": \"Keycloak\",                    \"type\": \"hard\"                },                {                    \"name\": \"Angular (Web Framework)\",                    \"type\": \"hard\"                },                {                    \"name\": \"Mobility\",                    \"type\": \"hard\"                },                {                    \"name\": \"Reinsurance\",                    \"type\": \"hard\"                },                {                    \"name\": \"Junit\",                    \"type\": \"hard\"                },                {                    \"name\": \"Hystrix\",                    \"type\": \"hard\"                },                {                    \"name\": \"Java Message Service (JMS)\",                    \"type\": \"hard\"                },                {                    \"name\": \"OpenKM\",                    \"type\": \"hard\"                },                {                    \"name\": \"PostgreSQL\",                    \"type\": \"hard\"                },                {                    \"name\": \"Transformation (Genetics)\",                    \"type\": \"hard\"                },                {                    \"name\": \"Reconciliation\",                    \"type\": \"hard\"                },                {                    \"name\": \"NoSQL\",                    \"type\": \"hard\"                },                {                    \"name\": \"Mockito\",                    \"type\": \"hard\"                }            ],            \"certifications\": [                {                    \"name\": \"Programming and Reactive Programming as well as other programming paradigms for handling high volume\",                    \"type\": null                },                {                    \"name\": \"ERASMUS EXCHANGE PROGRAME LEICESTER UK\",                    \"type\": null                }            ],            \"courses\": [],            \"publications\": [],            \"interests\": []        },        \"cost\": 0.07    },    \"eden-ai\": {        \"status\": \"success\",        \"extracted_data\": {            \"personal_infos\": {                \"name\": {                    \"first_name\": \"Ahmet\",                    \"last_name\": \"Uygun\",                    \"raw_name\": \"AHMET UYGUN\",                    \"middle\": \"\",                    \"title\": \"\",                    \"prefix\": null,                    \"sufix\": null                },                \"address\": {                    \"formatted_location\": \"Marino Park Avenue, Dublin, Ireland\",                    \"postal_code\": null,                    \"region\": \"Dublin\",                    \"country\": \"Ireland\",                    \"country_code\": \"IE\",                    \"raw_input_location\": \"Marino Park Ave. Dublin Ireland\",                    \"street\": \"Marino Park Avenue\",                    \"street_number\": null,                    \"appartment_number\": null,                    \"city\": \"Dublin\"                },                \"self_summary\": \"Experienced Sr Java Software Engineer with 9+ years of expertise in full project lifecycle development using Java technologies. Proficient in Java backend development and skilled in JavaScript-based frameworks including React, Angular, and React Native. Demonstrated expertise in Microservices, Domain Driven Desing, Event Driven Programming, and Reactive Programming, as well as other programming paradigms for handling high volume transactions. Proficient in Java, Spring Framework (Boot, Security, Data, Rest, etc.), Microservice instruments (Eureka, Hystrix, Zool), JMS, Kafka, Debezium, OpenShift AMQ Broker, Docker, AWS, Junit, Mockito, and RDMS (MySQL, PostgreSQL, Oracle), with additional skills in Angular, React, React Native, and Jhipster.\",                \"objective\": \"\",                \"date_of_birth\": null,                \"place_of_birth\": null,                \"phones\": [                    \"+353851066672\"                ],                \"mails\": [                    \"ygnhmt@gmail.com\"                ],                \"urls\": [                    \"https://github.com/ahmetuygun\",                    \"https://medium.com/@ygnhmt\",                    \"www.linkedin.com/ahmetuygun\",                    \"http://www.linkedin.com/ahmetuygun\"                ],                \"fax\": [],                \"current_profession\": \"Software Engineer Java\",                \"gender\": null,                \"nationality\": null,                \"martial_status\": null,                \"current_salary\": null            },            \"education\": {                \"total_years_education\": null,                \"entries\": [                    {                        \"title\": null,                        \"start_date\": \"2009-01-01\",                        \"end_date\": \"2014-01-01\",                        \"location\": {                            \"formatted_location\": \"İstanbul, Turkey\",                            \"postal_code\": null,                            \"region\": \"İstanbul\",                            \"country\": \"Turkey\",                            \"country_code\": \"TR\",                            \"raw_input_location\": \"ISTANBUL\",                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": \"İstanbul\"                        },                        \"establishment\": \"Kadir Has University\",                        \"description\": null,                        \"gpa\": null,                        \"accreditation\": \"B.SC, INFORMATION TECHNOLOGIES,\"                    },                    {                        \"title\": null,                        \"start_date\": \"2013-01-01\",                        \"end_date\": \"2013-01-01\",                        \"location\": {                            \"formatted_location\": \"Leicester, UK\",                            \"postal_code\": null,                            \"region\": \"England\",                            \"country\": \"United Kingdom\",                            \"country_code\": \"GB\",                            \"raw_input_location\": \"LEICESTER UK\",                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": \"Leicester\"                        },                        \"establishment\": null,                        \"description\": null,                        \"gpa\": null,                        \"accreditation\": \"ERASMUS EXCHANGE PROGRAME,\"                    }                ]            },            \"work_experience\": {                \"total_years_experience\": null,                \"entries\": [                    {                        \"title\": \"SR JAVA SOFTWARE ENGINEER\",                        \"start_date\": \"2022-12-01\",                        \"end_date\": \"2024-01-28\",                        \"company\": \"VERSION 1, DUBLIN, IRELAND (ON SIDE)\",                        \"location\": {                            \"formatted_location\": null,                            \"postal_code\": null,                            \"region\": null,                            \"country\": null,                            \"country_code\": null,                            \"raw_input_location\": null,                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": null                        },                        \"description\": null,                        \"industry\": null                    },                    {                        \"title\": \"SR JAVA SOFTWARE ENGINEER\",                        \"start_date\": \"2021-10-01\",                        \"end_date\": \"2022-12-01\",                        \"company\": \"DERAYAH FINANCIAL (D360 DIGITAL BANK), RIYADH DE\",                        \"location\": {                            \"formatted_location\": null,                            \"postal_code\": null,                            \"region\": null,                            \"country\": null,                            \"country_code\": null,                            \"raw_input_location\": null,                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": null                        },                        \"description\": null,                        \"industry\": null                    },                    {                        \"title\": \"SR JAVA SOFTWARE ENGINEER\",                        \"start_date\": \"2020-10-01\",                        \"end_date\": \"2021-10-01\",                        \"company\": \"DAIMLER MOBILITY AG, STUTTGART DE\",                        \"location\": {                            \"formatted_location\": null,                            \"postal_code\": null,                            \"region\": null,                            \"country\": null,                            \"country_code\": null,                            \"raw_input_location\": null,                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": null                        },                        \"description\": null,                        \"industry\": null                    },                    {                        \"title\": \"SR JAVA SOFTWARE ENGINEER\",                        \"start_date\": \"2019-05-01\",                        \"end_date\": \"2021-10-01\",                        \"company\": \"VODAFONE, ISTANBUL (ON SIDE)\",                        \"location\": {                            \"formatted_location\": null,                            \"postal_code\": null,                            \"region\": null,                            \"country\": null,                            \"country_code\": null,                            \"raw_input_location\": null,                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": null                        },                        \"description\": null,                        \"industry\": null                    },                    {                        \"title\": \"JAVA SOFTWARE ENGINEER\",                        \"start_date\": \"2017-04-01\",                        \"end_date\": \"2019-05-01\",                        \"company\": \"Ergo Insurance\",                        \"location\": {                            \"formatted_location\": \"İstanbul, Turkey\",                            \"postal_code\": null,                            \"region\": \"İstanbul\",                            \"country\": \"Turkey\",                            \"country_code\": \"TR\",                            \"raw_input_location\": \"ISTANBUL\",                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": \"İstanbul\"                        },                        \"description\": null,                        \"industry\": null                    },                    {                        \"title\": \"JAVA SOFTWARE ENGINEER\",                        \"start_date\": \"2014-02-01\",                        \"end_date\": \"2017-04-01\",                        \"company\": \"Netas Telecom\",                        \"location\": {                            \"formatted_location\": \"İstanbul, Turkey\",                            \"postal_code\": null,                            \"region\": \"İstanbul\",                            \"country\": \"Turkey\",                            \"country_code\": \"TR\",                            \"raw_input_location\": \"ISTANBUL\",                            \"street\": null,                            \"street_number\": null,                            \"appartment_number\": null,                            \"city\": \"İstanbul\"                        },                        \"description\": null,                        \"industry\": null                    }                ]            },            \"languages\": [                {                    \"name\": \"Portuguese\",                    \"code\": null                },                {                    \"name\": \"English\",                    \"code\": null                }            ],            \"skills\": [                {                    \"name\": \"Hibernate (Java)\",                    \"type\": \"hard\"                },                {                    \"name\": \"Microservices\",                    \"type\": \"hard\"                },                {                    \"name\": \"Java (Programming Language)\",                    \"type\": \"hard\"                },                {                    \"name\": \"SMS\",                    \"type\": \"hard\"                },                {                    \"name\": \"Monoliths\",                    \"type\": \"hard\"                },                {                    \"name\": \"Amazon S3\",                    \"type\": \"hard\"                },                {                    \"name\": \"Application Programming Interface (API)\",                    \"type\": \"hard\"                },                {                    \"name\": \"User Experience Design (UX)\",                    \"type\": \"hard\"                },                {                    \"name\": \"Zope (CMS)\",                    \"type\": \"hard\"                },                {                    \"name\": \"SQL (Programming Language)\",                    \"type\": \"hard\"                },                {                    \"name\": \"Apache Kafka\",                    \"type\": \"hard\"                },                {                    \"name\": \"Amazon Web Services\",                    \"type\": \"hard\"                },                {                    \"name\": \"Jhipster\",                    \"type\": \"hard\"                },                {                    \"name\": \"MySQL\",                    \"type\": \"hard\"                },                {                    \"name\": \"Management\",                    \"type\": \"soft\"                },                {                    \"name\": \"Docker (Software)\",                    \"type\": \"hard\"                },                {                    \"name\": \"Mobile App\",                    \"type\": \"hard\"                },                {                    \"name\": \"Communications\",                    \"type\": \"soft\"                },                {                    \"name\": \"Spring Framework\",                    \"type\": \"hard\"                },                {                    \"name\": \"React Native\",                    \"type\": \"hard\"                },                {                    \"name\": \"OpenShift\",                    \"type\": \"hard\"                },                {                    \"name\": \"Staging\",                    \"type\": \"hard\"                },                {                    \"name\": \"Spring Security\",                    \"type\": \"hard\"                },                {                    \"name\": \"Keycloak\",                    \"type\": \"hard\"                },                {                    \"name\": \"Angular (Web Framework)\",                    \"type\": \"hard\"                },                {                    \"name\": \"Mobility\",                    \"type\": \"hard\"                },                {                    \"name\": \"Reinsurance\",                    \"type\": \"hard\"                },                {                    \"name\": \"Junit\",                    \"type\": \"hard\"                },                {                    \"name\": \"Hystrix\",                    \"type\": \"hard\"                },                {                    \"name\": \"Java Message Service (JMS)\",                    \"type\": \"hard\"                },                {                    \"name\": \"OpenKM\",                    \"type\": \"hard\"                },                {                    \"name\": \"PostgreSQL\",                    \"type\": \"hard\"                },                {                    \"name\": \"Transformation (Genetics)\",                    \"type\": \"hard\"                },                {                    \"name\": \"Reconciliation\",                    \"type\": \"hard\"                },                {                    \"name\": \"NoSQL\",                    \"type\": \"hard\"                },                {                    \"name\": \"Mockito\",                    \"type\": \"hard\"                }            ],            \"certifications\": [                {                    \"name\": \"Programming and Reactive Programming as well as other programming paradigms for handling high volume\",                    \"type\": null                },                {                    \"name\": \"ERASMUS EXCHANGE PROGRAME LEICESTER UK\",                    \"type\": null                }            ],            \"courses\": [],            \"publications\": [],            \"interests\": []        }    }}";

        JSONObject raw_data = new JSONObject(response.getBody());
        JSONObject jsonObject = raw_data.getJSONObject("affinda").getJSONObject("extracted_data");


        PersonalDetail personalDetail = toPersonalDetail(cv ,  cvContentType , jsonObject);
        Set<WorkExperienceEntry> workExperienceEntryList = toWorkExperienceEntryList(jsonObject);
        personalDetail.setWorks(workExperienceEntryList);
        Set<EducationEntry> educationEntryList = toEducationEntryList(jsonObject);
        personalDetail.setEducations(educationEntryList);
        personalDetail.setSkills(getSkills(jsonObject));
        personalDetail.setLanguages(getLanguages(jsonObject));

        return personalDetail;
    }

    private String getSkills(JSONObject jsonObject) throws JsonProcessingException {

        ObjectMapper mapper = new ObjectMapper();

        JSONArray languagesJson = jsonObject.getJSONArray(SKILLS);
        Skill[] skills = mapper.readValue(languagesJson.toString(), Skill[].class);
        return Arrays.stream(skills).map( item -> item.getName())
            .collect(Collectors.joining("-"));

    }

    private String getLanguages(JSONObject jsonObject) throws JsonProcessingException {
        ObjectMapper mapper = new ObjectMapper();

        JSONArray languagesJson = jsonObject.getJSONArray(LANGUAGES);
        Language[] languages = mapper.readValue(languagesJson.toString(), Language[].class);
        return Arrays.stream(languages).map( item -> item.getName())
            .collect(Collectors.joining("-"));
    }

    private Set<EducationEntry> toEducationEntryList(JSONObject jsonObject) throws JsonProcessingException {
        ObjectMapper mapper = new ObjectMapper();

        JSONObject educationJson = jsonObject.getJSONObject(EDUCATION);
        Education education = mapper.readValue(educationJson.toString(), Education.class);

        return education.getEntries().stream().map(item -> toEducationEntry(item)).collect(Collectors.toSet());

    }

    private EducationEntry toEducationEntry(Entry entry) {

        EducationEntry educationEntry = new EducationEntry();
        educationEntry.setStartDate(toLocalDate(entry.getStartDate()));
        educationEntry.setEndDate(toLocalDate(entry.getEndDate()));
        educationEntry.setEstablishment(entry.getEstablishment());
        educationEntry.setAccreditation(entry.getAccreditation());

        return educationEntry;
    }

    private Set<WorkExperienceEntry> toWorkExperienceEntryList(JSONObject jsonObject) throws JsonProcessingException {

        ObjectMapper mapper = new ObjectMapper();

        JSONObject workExperienceJson = jsonObject.getJSONObject(WORK_EXPERIENCE);
        WorkExperience workExperiences = mapper.readValue(workExperienceJson.toString(), WorkExperience.class);

        return workExperiences.getEntries().stream().map( item -> toWorkExperienceEntry(item)).collect(Collectors.toSet());


    }

    private WorkExperienceEntry toWorkExperienceEntry(Entry__1 entry) {

        WorkExperienceEntry workExperienceEntry = new WorkExperienceEntry();
        workExperienceEntry.setCompany(entry.getCompany());
        workExperienceEntry.title(entry.getTitle());
        workExperienceEntry.setStartDate(toInstant(entry.getStartDate()));
        workExperienceEntry.setEndDate(toInstant(entry.getEndDate()));

        return workExperienceEntry;

    }

    private PersonalDetail toPersonalDetail(byte[] cv, String cvContentType, JSONObject jsonObject) throws JsonProcessingException {
        ObjectMapper mapper = new ObjectMapper();

        JSONObject personalInfosJson = jsonObject.getJSONObject(PERSONAL_INFOS);
        PersonalInfos personalInfos = mapper.readValue(personalInfosJson.toString(), PersonalInfos.class);

        PersonalDetail personalDetail = new PersonalDetail();
        personalDetail.setCountry(personalInfos.getAddress().getCountry());
        personalDetail.setFirstName(personalInfos.getName().getFirstName());
        personalDetail.setLastName(personalInfos.getName().getLastName());
        personalDetail.setCity(personalInfos.getAddress().getCity());
        personalDetail.setSelfSummary(personalInfos.getSelfSummary());
        personalDetail.setDateOfBirth(toInstant(personalInfos.getDateOfBirth()));
        personalDetail.setPlaceOfBirth(personalInfos.getPlaceOfBirth());
        personalDetail.setPhones(personalInfos.getPhones() != null && personalInfos.getPhones().size() >0 ? personalInfos.getPhones().get(0) : null);
        personalDetail.setMails(personalInfos.getMails() != null && personalInfos.getMails().size() >0 ? personalInfos.getMails().get(0) : null);
        personalDetail.setUrls(personalInfos.getUrls() != null && personalInfos.getUrls().size() >0 ? personalInfos.getUrls().get(0) : null);
        personalDetail.setCurrentProfession(personalInfos.getCurrentProfession());
        personalDetail.setGender(personalInfos.getGender());
        return personalDetail;
    }

    private Instant toInstant(Object dateOfBirth) {

         try {
             LocalDate localDate = LocalDate.parse((String)dateOfBirth);
             return localDate.atStartOfDay().toInstant(ZoneOffset.UTC);
         }catch (Exception e){
             return null;
         }

    }

    private LocalDate toLocalDate(Object dateOfBirth) {

        try {
            return LocalDate.parse((String)dateOfBirth);
        }catch (Exception e){
            return null;
        }

    }


    public File byteToFile( byte[] fileContent) throws IOException {
        File file = File.createTempFile(String.valueOf(System.currentTimeMillis()), ".pdf");
        FileUtils.writeByteArrayToFile(file, fileContent);
        return file;
    }

}
